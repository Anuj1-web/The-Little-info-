<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comments - The Little Info</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-container">
      <img src="logo.png" alt="Site Logo" class="site-logo" />
      <nav>
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="profile.html">Profile</a>
        <a href="login.html" class="btn">Logout</a>
        <label class="theme-switch">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider"></span>
        </label>
      </nav>
    </div>
  </header>

  <!-- Comment Section -->
  <main class="section-container">
    <h1>Leave a Comment</h1>

    <form id="commentForm" class="content-form">
      <label for="commentText">Your Comment:</label>
      <textarea id="commentText" rows="3" placeholder="Type something..." required></textarea>
      <button type="submit" class="btn">Post Comment</button>
    </form>

    <div id="commentsContainer" class="comments-list">
      <p>Loading comments...</p>
    </div>
  </main>

  <!-- Firebase Comments Logic -->
  <script type="module">
    import { auth, db } from './firebaseInit.js';
    import {
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import {
      collection,
      addDoc,
      getDocs,
      serverTimestamp,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    const commentForm = document.getElementById('commentForm');
    const commentText = document.getElementById('commentText');
    const commentsContainer = document.getElementById('commentsContainer');

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert('Please login to view and post comments.');
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      loadComments();
    });

    async function loadComments() {
      try {
        const q = query(collection(db, "comments"), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(q);
        commentsContainer.innerHTML = "";

        if (snapshot.empty) {
          commentsContainer.innerHTML = "<p>No comments yet.</p>";
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const comment = document.createElement("div");
          comment.className = "comment-card fade-in";
          comment.innerHTML = `
            <strong>${data.userEmail}</strong>
            <p>${data.text}</p>
            <span class="timestamp">${data.timestamp?.toDate().toLocaleString() || ''}</span>
          `;
          commentsContainer.appendChild(comment);
        });
      } catch (error) {
        console.error("Error fetching comments:", error);
        commentsContainer.innerHTML = "<p>Error loading comments.</p>";
      }
    }

    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = commentText.value.trim();
      if (!text || !currentUser) return;

      try {
        await addDoc(collection(db, "comments"), {
          text,
          userEmail: currentUser.email,
          timestamp: serverTimestamp()
        });

        commentText.value = "";
        loadComments();
      } catch (error) {
        console.error("Failed to post comment:", error);
        alert("Failed to post comment.");
      }
    });
  </script>

  <!-- Theme Toggle -->
  <script>
    const toggle = document.getElementById("theme-toggle");
    toggle.addEventListener("change", () => {
      document.body.classList.toggle("light-mode");
      localStorage.setItem("theme", document.body.classList.contains("light-mode") ? "light" : "dark");
    });

    window.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("theme") === "light") {
        document.body.classList.add("light-mode");
        toggle.checked = true;
      }
    });
  </script>
</body>
</html>
